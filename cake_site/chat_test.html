<!-- test_chat_fixed.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —á–∞—Ç–∞ Cake Site (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9; }
        h2 { color: #333; margin-top: 0; }
        input, button { padding: 10px; margin: 5px 0; font-size: 14px; }
        input { width: calc(100% - 22px); border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; min-width: 120px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .status-box { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status-connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-connecting { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        #messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; margin: 15px 0; background: white; }
        .message { margin: 8px 0; padding: 8px 12px; border-radius: 8px; max-width: 80%; }
        .message-system { background: #e9ecef; color: #495057; font-style: italic; margin: 10px auto; text-align: center; max-width: 100%; }
        .message-me { background: #007bff; color: white; margin-left: auto; }
        .message-other { background: #f1f3f5; color: #212529; margin-right: auto; }
        .message-connection { background: #d1ecf1; color: #0c5460; text-align: center; max-width: 100%; }
        .message-user { font-weight: bold; margin-right: 5px; }
        .message-time { font-size: 11px; opacity: 0.7; margin-left: 10px; }
        .users-online { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; }
        .user-badge { background: #e9ecef; padding: 5px 10px; border-radius: 20px; font-size: 12px; }
        .debug-panel { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 20px; font-size: 12px; }
        .debug-toggle { font-size: 12px; color: #6c757d; cursor: pointer; }
        .debug-content { display: none; margin-top: 10px; }
        pre { background: white; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üõ† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket —á–∞—Ç–∞ Cake Site</h1>
    
    <!-- –°–µ–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="section">
        <h2>üîê 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <p><strong>–í–∞–∂–Ω–æ:</strong> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Form URL encoded —Ñ–æ—Ä–º–∞—Ç (username/password)</p>
        
        <div>
            <input type="email" id="email" placeholder="Email" value="admin@example.com">
        </div>
        <div>
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="admin123">
        </div>
        <div>
            <button onclick="login()" id="loginBtn">–í–æ–π—Ç–∏</button>
            <button onclick="logout()" class="danger">–í—ã–π—Ç–∏</button>
        </div>
        
        <div id="authStatus" class="status-box status-disconnected">
            üîí –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        </div>
        <div id="authError" style="color: #dc3545; margin-top: 10px;"></div>
    </div>
    
    <!-- –°–µ–∫—Ü–∏—è —á–∞—Ç–∞ -->
    <div class="section" id="chatSection" style="display:none;">
        <h2>üí¨ 2. –ß–∞—Ç</h2>
        
        <div id="connectionStatus" class="status-box status-disconnected">
            üì° –°—Ç–∞—Ç—É—Å: <span id="wsStatusText">–û—Ç–∫–ª—é—á–µ–Ω</span>
        </div>
        
        <div>
            üë• –û–Ω–ª–∞–π–Ω: <span id="onlineCount">0</span> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            <div id="onlineUsers" class="users-online"></div>
        </div>
        
        <div id="messages">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>
        
        <div>
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
            <button id="sendBtn" onclick="sendMessage()" disabled>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button onclick="disconnectWebSocket()" class="danger">üîå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button onclick="reconnectWebSocket()" class="success">üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
        
        <div id="chatError" style="color: #dc3545; margin-top: 10px;"></div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ -->
    <div class="section debug-panel">
        <div class="debug-toggle" onclick="toggleDebug()">
            üìä <strong>–ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏</strong> (–Ω–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å/—Å–≤–µ—Ä–Ω—É—Ç—å)
        </div>
        <div class="debug-content" id="debugContent">
            <div>
                <button onclick="testAuth()">üß™ –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
                <button onclick="showTokens()">üîë –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
                <button onclick="clearTokens()">üóë –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
                <button onclick="testWebSocket()">üîå –¢–µ—Å—Ç WebSocket</button>
            </div>
            
            <div style="margin-top: 15px;">
                <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                <div>Access Token: <span id="tokenPreview">–Ω–µ—Ç</span></div>
                <div>WebSocket URL: <code id="wsUrl">–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</code></div>
                <div>User ID: <span id="userId">–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span></div>
            </div>
            
            <div style="margin-top: 15px;">
                <h4>–õ–æ–≥–∏:</h4>
                <pre id="debugLogs"></pre>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let accessToken = localStorage.getItem('access_token') || '';
        let refreshToken = localStorage.getItem('refresh_token') || '';
        let ws = null;
        let userId = '';
        let userName = '';
        let userEmail = '';
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        function debugLog(message, type = 'info') {
            const logs = document.getElementById('debugLogs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff';
            logs.innerHTML += `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            
            // –¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
            if (type === 'error') console.error(message);
            else if (type === 'success') console.log('%c' + message, 'color: green');
            else console.log(message);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            debugLog('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
            
            if (accessToken) {
                // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                checkStoredToken();
            }
        };
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        async function checkStoredToken() {
            try {
                debugLog('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞...', 'info');
                
                const response = await fetch('/users/', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    userId = userData.id;
                    userName = userData.full_name;
                    userEmail = userData.email;
                    
                    updateAuthStatus(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ${userName} (${userEmail})`, 'status-connected');
                    showChatSection();
                    connectWebSocket();
                    
                    debugLog(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: ${userName} (ID: ${userId})`, 'success');
                } else {
                    // –ü—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
                    debugLog('–¢–æ–∫–µ–Ω —É—Å—Ç–∞—Ä–µ–ª, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å...', 'info');
                    await refreshAccessToken();
                }
            } catch (error) {
                debugLog(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞: ${error.message}`, 'error');
                clearTokens();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏
            document.getElementById('authError').textContent = '';
            debugLog(`–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è: ${email}`, 'info');
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Form URL encoded —Ñ–æ—Ä–º–∞—Ç
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: new URLSearchParams({
                        'username': email,
                        'password': password
                    })
                });
                
                debugLog(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`, 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`–û—à–∏–±–∫–∞ ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω—ã
                accessToken = data.access_token;
                refreshToken = data.refresh_token;
                localStorage.setItem('access_token', accessToken);
                localStorage.setItem('refresh_token', refreshToken);
                
                debugLog('–¢–æ–∫–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                const userResponse = await fetch('/users/', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    userId = userData.id;
                    userName = userData.full_name;
                    userEmail = userData.email;
                    
                    debugLog(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ–ª—É—á–µ–Ω–∞: ${userName}`, 'success');
                }
                
                updateAuthStatus(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ${userName || email}`, 'status-connected');
                document.getElementById('authError').textContent = '';
                showChatSection();
                connectWebSocket();
                
            } catch (error) {
                const errorMsg = `–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`;
                document.getElementById('authError').textContent = errorMsg;
                debugLog(errorMsg, 'error');
                updateAuthStatus('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'status-disconnected');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞
        async function refreshAccessToken() {
            try {
                debugLog('–ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access —Ç–æ–∫–µ–Ω–∞...', 'info');
                
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    localStorage.setItem('access_token', accessToken);
                    debugLog('–¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    checkStoredToken(); // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º
                } else {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω');
                }
            } catch (error) {
                debugLog(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ${error.message}`, 'error');
                clearTokens();
            }
        }
        
        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            clearTokens();
            updateAuthStatus('üîí –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 'status-disconnected');
            document.getElementById('chatSection').style.display = 'none';
            debugLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
        }
        
        // –û—á–∏—Å—Ç–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
        function clearTokens() {
            accessToken = '';
            refreshToken = '';
            userId = '';
            userName = '';
            userEmail = '';
            
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            updateTokenPreview();
            debugLog('–¢–æ–∫–µ–Ω—ã –æ—á–∏—â–µ–Ω—ã', 'info');
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function connectWebSocket() {
            if (!accessToken) {
                debugLog('–û—à–∏–±–∫–∞: –ù–µ—Ç access —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket', 'error');
                alert('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!');
                return;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (ws) {
                ws.close();
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}/ws/chat?token=${accessToken}`;
            
            document.getElementById('wsUrl').textContent = wsUrl;
            debugLog(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket: ${wsUrl}`, 'info');
            
            ws = new WebSocket(wsUrl);
            
            updateConnectionStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'status-connecting');
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            ws.onopen = function() {
                debugLog('‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                updateConnectionStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω', 'status-connected');
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('messageInput').focus();
                
                addMessageToChat('system', `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç, ${userName || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}!`);
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    debugLog(`–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
                    handleWebSocketMessage(data);
                } catch (e) {
                    debugLog(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${e.message}`, 'error');
                }
            };
            
            ws.onclose = function(event) {
                debugLog(`WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –ö–æ–¥: ${event.code}, –ø—Ä–∏—á–∏–Ω–∞: ${event.reason || '–Ω–µ—Ç'}`, 'info');
                updateConnectionStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω', 'status-disconnected');
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                
                addMessageToChat('system', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (accessToken) {
                        debugLog('–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'info');
                        connectWebSocket();
                    }
                }, 5000);
            };
            
            ws.onerror = function(error) {
                debugLog(`WebSocket –æ—à–∏–±–∫–∞: ${error}`, 'error');
                updateConnectionStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'status-disconnected');
            };
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'message':
                    const isMyMessage = data.user_email === userEmail;
                    addMessageToChat(isMyMessage ? 'me' : 'other', 
                        `<span class="message-user">${data.user_name}:</span> ${data.message}`, 
                        data.timestamp);
                    break;
                    
                case 'system':
                    addMessageToChat('system', data.message);
                    break;
                    
                case 'connection':
                    const action = data.action === 'connected' ? '–ø–æ–¥–∫–ª—é—á–∏–ª—Å—è' : '–æ—Ç–∫–ª—é—á–∏–ª—Å—è';
                    addMessageToChat('connection', `${data.user_name} ${action}`);
                    updateOnlineCount(data.online_count);
                    break;
                    
                case 'history':
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                    data.data.forEach(msg => {
                        const isMyMessage = msg.user_email === userEmail;
                        addMessageToChat(isMyMessage ? 'me' : 'other', 
                            `<span class="message-user">${msg.user_name}:</span> ${msg.message}`, 
                            msg.created_at);
                    });
                    break;
                    
                default:
                    debugLog(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: ${data.type}`, 'info');
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                const messageData = {
                    type: 'message',
                    message: message
                };
                
                ws.send(JSON.stringify(messageData));
                debugLog(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${message}"`, 'info');
                input.value = '';
            } else {
                debugLog('–û—à–∏–±–∫–∞: WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                alert('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —á–∞—Ç—É!');
            }
        }
        
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç WebSocket
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                debugLog('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –≤—Ä—É—á–Ω—É—é', 'info');
            }
        }
        
        // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function reconnectWebSocket() {
            disconnectWebSocket();
            setTimeout(() => {
                connectWebSocket();
            }, 1000);
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI
        function updateAuthStatus(text, className) {
            const authStatus = document.getElementById('authStatus');
            authStatus.textContent = text;
            authStatus.className = `status-box ${className}`;
        }
        
        function updateConnectionStatus(text, className) {
            document.getElementById('wsStatusText').textContent = text;
            document.getElementById('connectionStatus').className = `status-box ${className}`;
        }
        
        function showChatSection() {
            document.getElementById('chatSection').style.display = 'block';
        }
        
        function addMessageToChat(type, text, timestamp = null) {
            const messages = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message message-${type}`;
            
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            msgDiv.innerHTML = `${text} <span class="message-time">${time}</span>`;
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function updateOnlineCount(count) {
            document.getElementById('onlineCount').textContent = count;
        }
        
        function updateTokenPreview() {
            const preview = document.getElementById('tokenPreview');
            preview.textContent = accessToken ? `${accessToken.substring(0, 20)}...` : '–Ω–µ—Ç';
            document.getElementById('userId').textContent = userId || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–ª–∞–¥–∫–∏
        function toggleDebug() {
            const content = document.getElementById('debugContent');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }
        
        function testAuth() {
            debugLog('=== –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ===', 'info');
            login();
        }
        
        function showTokens() {
            updateTokenPreview();
            debugLog(`Access Token: ${accessToken || '–Ω–µ—Ç'}`, 'info');
            debugLog(`Refresh Token: ${refreshToken || '–Ω–µ—Ç'}`, 'info');
            debugLog(`User ID: ${userId || '–Ω–µ—Ç'}`, 'info');
            debugLog(`User Name: ${userName || '–Ω–µ—Ç'}`, 'info');
        }
        
        function testWebSocket() {
            if (ws) {
                debugLog(`WebSocket —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${ws.readyState}`, 'info');
                debugLog(`WebSocket URL: ${ws.url}`, 'info');
            } else {
                debugLog('WebSocket –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'info');
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–∫–µ–Ω–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(updateTokenPreview, 1000);
        
        // –ê–≤—Ç–æ-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        // setTimeout(() => {
        //     if (accessToken) {
        //         debugLog('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞...', 'info');
        //         checkStoredToken();
        //     }
        // }, 1000);
    </script>
</body>
</html>